{%- assign counter = 0 -%}
{%- assign break_at = section.settings.number_of_products | plus: 0 -%}
{%- assign current_product = product -%}

{%- capture related_items -%}
<section
    class="product-section--container product-row--container product-recommendations--container"
    data-html
  >
    {% if recommendations.products_count > 0 %}
      <h2 class="product-section--title product-recommendations--title">
        {{ section.settings.related_title }}
      </h2>

      <ul
        class="
          product-section--content
          product-row
          {% if settings.enable_product_card_spacing == false %}product-row--no-spacing{% endif %}
        "
        data-product-row
      >
        {% for product in collections['all'].products %}
            {%- unless product.handle == current_product.handle -%}

                {%- if product.tags contains section.settings.related_tag -%}
                    {%
                        include 'product-grid-item',
                        product: product
                    %}

                    {%- assign counter = counter | plus: 1 -%}

                    {%- if counter == break_at -%}
                    {%- break -%}
                    {%- endif -%}

                {%- endif -%}

            {%- endunless -%}
        {%- endfor -%}
        </ul>
    {% endif %}
</section>
{%- endcapture -%}

{%- assign related_items = related_items | trim -%}
{%- unless related_items == blank -%}
  <aside>
    {%- if section.settings.heading -%}
      <h2>{{ section.settings.heading }}</h2>
    {%- endif -%}

    {{ related_items }}
  </aside>
{%- endunless -%}



{% assign number_of_related_products_to_show = 2 %} 
    {% assign current_product = product %} {% assign current_product_tags = product.tags %} 
    {% assign found_first_match = false %} {% assign found_second_match = false %} 
    {% assign first_related_product = true %} 
    {% paginate collections.all.products by 10 %} 
    {% for product in collections.all.products %} 
    {% unless product.handle == current_product.handle %}
     {% for tag in product.tags %} 
    {% if current_product_tags contains tag %} 
    {% if found_first_match == false %} 
    {% assign found_first_match = true %} 
    {% assign first_match = tag %} 
    {% else %} 
    {% assign found_second_match = true %}
     {% assign second_match = tag %}
     {% endif %}
     {% endif %}
     {% endfor %}
     {% if found_first_match == true %}
     {% if first_related_product == true %} 
    {% assign first_related_product = false %}
        Related products
        {% endif %}
     {% if product.tags contains first_match or product.tags contains second_match %} 
    {% include 'product-grid-item' with collection.handle %} 
    {% endif %} 
    {% endif %} 
    {% endunless %} 
    {% endfor %} 
    {% if first_related_product == false %}
        {% endif %}
     {% endpaginate %} 


{% if product.tags.size > 0 %}
  <div class="related-products">
    <h2>Related Products</h2>
    <div class="related-products-grid">
      {% assign related_products = collections.all.products %}
      {% for tag in product.tags %}
        {% assign related_products_in_tag = '' %}
        {% for related_product in related_products %}
          {% if related_product.tags contains tag %}
            {% assign related_products_in_tag = related_products_in_tag | append: related_product %}
          {% endif %}
        {% endfor %}
        {% assign related_products = related_products_in_tag %}
      {% endfor %}
  {{ related_products }}
      {% for related_product in related_products %}
        <div class="related-product">
          <a href="{{ related_product.url }}">
            <img src="{{ related_product.featured_image.src | img_url: 'medium' }}" alt="{{ related_product.title }}">
            <h3>{{ related_product.title }}</h3>
            <span class="price">{{ related_product.price | money }}</span>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}











{% schema %}
{
  "name": "Related products",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_related_products",
      "label": "Show related products",
      "default": false
    },
    {
      "id": "related_title",
      "type": "text",
      "label": "Section title",
      "default": "Other fine products"
    },
    {
      "type": "select",
      "id": "number_of_products",
      "label": "Products per row (Desktop)",
      "default": "4",
      "options": [
        {
          "value": "2",
          "label": "2"
        },
        {
          "value": "3",
          "label": "3"
        },
        {
          "value": "4",
          "label": "4"
        },
        {
          "value": "5",
          "label": "5"
        }
      ]
    },
    {
    "type": "text",
    "id": "related_tag",
    "label": "Related Product Tag"
    }
  ]
}
{% endschema %}